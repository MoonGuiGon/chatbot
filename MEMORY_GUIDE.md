# 🧠 메모리 시스템 가이드

## 개요

사용자별 메모리 시스템이 추가되어 챗봇이 대화 내용을 기억하고 맥락을 이해합니다.

## 🎯 메모리 시스템의 2가지 레벨

### 1. 단기 메모리 (대화 컨텍스트)
- **목적**: 현재 대화의 맥락 유지
- **범위**: 현재 conversation_id 내의 메시지
- **저장 기간**: 대화가 끝나면 소멸
- **최대 메시지**: 10개 (user + assistant = 20개 메시지)

**예시:**
```
User: 부품 ABC-12345의 재고는?
Bot: 1,000개입니다.
User: 그 부품 최근 출고 이력도 알려줘
Bot: (이전 대화에서 "그 부품"이 ABC-12345임을 기억하고 답변)
```

### 2. 장기 메모리 (사용자 정보)
- **목적**: 사용자에 대한 중요 정보 영구 저장
- **범위**: 모든 대화에 걸쳐 유지
- **저장 기간**: 사용자가 삭제하기 전까지 영구
- **자동 저장**: 10개 메시지마다 자동으로 중요 정보 추출

**예시:**
```
대화 1:
User: 나는 생산팀 소속이야
Bot: 알겠습니다. 앞으로 생산 관련 정보를 우선적으로 제공하겠습니다.
→ 메모리 저장: [역할] "생산팀 소속"

대화 2 (며칠 후):
User: 부품 재고 알려줘
Bot: (생산팀 소속임을 기억하고, 생산팀이 관심있을 정보 위주로 답변)
```

## 📊 메모리 카테고리

| 카테고리 | 설명 | 예시 |
|----------|------|------|
| **선호도** | 사용자의 선호사항 | "표 형식으로 답변 선호" |
| **역할** | 사용자의 부서/직책 | "생산팀 라인 1 담당" |
| **자주조회** | 자주 조회하는 정보 | "부품 ABC-12345 자주 조회" |
| **명시적요청** | 기억해달라고 요청한 내용 | "이 부품은 중요하니 기억해줘" |
| **업무컨텍스트** | 업무 관련 정보 | "신규 프로젝트 진행 중" |

## 🔄 메모리 동작 흐름

### 자동 메모리 저장
```
1. 사용자가 메시지 전송
   ↓
2. 단기 메모리에 메시지 추가
   ↓
3. LLM이 대화 컨텍스트 참조하여 답변
   ↓
4. 답변 메시지도 단기 메모리에 추가
   ↓
5. 메시지가 10개 이상 쌓이면
   ↓
6. LLM이 중요한 정보 자동 추출
   ↓
7. 장기 메모리(MongoDB)에 저장
```

### 메모리 활용 흐름
```
사용자 질문 입력
    ↓
1. 장기 메모리 조회 (사용자 정보)
2. 단기 메모리 조회 (이전 대화)
    ↓
3. 메모리 컨텍스트 생성
    ↓
4. LLM 프롬프트에 포함:
   - 사용자 정보
   - 이전 대화 내용
   - 검색된 문서
    ↓
5. 맥락을 고려한 답변 생성
```

## 💡 사용 예시

### 예시 1: 대화 맥락 유지

**대화 시작:**
```
User: 부품 ABC-12345의 재고는?
Bot: 부품 ABC-12345의 재고는 1,000개입니다.
```

**5분 후 (같은 대화):**
```
User: 그 부품 최근 출고 이력 알려줘
Bot: ABC-12345의 최근 출고 이력입니다:
     - 2024-01-15: 100개 (라인 1)
     - 2024-01-10: 50개 (라인 2)
```

**✅ "그 부품"이 ABC-12345임을 기억**

### 예시 2: 사용자 선호도 기억

**첫 대화:**
```
User: 앞으로 표 형식으로 답변해줘
Bot: 알겠습니다. 앞으로 표 형식으로 답변드리겠습니다.
→ 메모리 저장: [선호도] "표 형식 답변 선호"
```

**다음날 새로운 대화:**
```
User: 부품 재고 현황 알려줘
Bot: (표 형식으로 답변)

| 부품번호 | 부품명 | 재고 |
|---------|--------|------|
| ABC-12345 | 칩 A | 1,000 |
| ABC-12346 | 칩 B | 500 |
```

**✅ 이전에 표 형식을 선호한다고 한 것을 기억**

### 예시 3: 역할 기반 답변

**대화 1:**
```
User: 나는 생산팀 라인 1 담당이야
Bot: 알겠습니다. 생산팀 라인 1 관련 정보를 우선적으로 제공하겠습니다.
→ 메모리 저장: [역할] "생산팀 라인 1 담당"
```

**대화 2 (일주일 후):**
```
User: 부품 ABC-12345 정보 알려줘
Bot: 부품 ABC-12345 정보입니다.

     **라인 1 관련 정보:**
     - 최근 출고: 라인 1로 100개 출고
     - 장착 장비: EQ-001 (라인 1)

     (라인 1 관련 정보를 우선적으로 표시)
```

**✅ 사용자가 라인 1 담당임을 기억하고 관련 정보 우선 제공**

### 예시 4: 명시적 기억 요청

```
User: 부품 ABC-12345는 우리 팀 핵심 부품이야. 이거 꼭 기억해줘.
Bot: 네, 부품 ABC-12345가 귀하의 팀 핵심 부품이라는 것을 기억하겠습니다.
→ 메모리 저장: [명시적요청] "ABC-12345는 핵심 부품"
```

**나중에:**
```
User: 핵심 부품 재고 확인
Bot: 귀하의 핵심 부품 ABC-12345의 현재 재고는...
```

## 🎨 UI에서 메모리 관리

### 1. 설정 열기
```
상단 ⚙️ 버튼 클릭
→ "메모리 관리" 탭 클릭
```

### 2. 저장된 메모리 확인
```
- 카테고리별로 색상 구분
- 중요도 표시 (high/medium/low)
- 키워드와 내용 확인
```

### 3. 메모리 수동 추가
```
1. "추가" 버튼 클릭
2. 카테고리 선택
3. 키워드 입력 (예: "선호 형식")
4. 내용 입력 (예: "표와 그래프 위주")
5. 중요도 선택
6. "추가" 클릭
```

### 4. 메모리 삭제
```
- 각 메모리 옆 🗑️ 버튼으로 개별 삭제
- "초기화" 버튼으로 전체 삭제
```

## 🔌 API 사용법

### 메모리 조회
```javascript
GET /api/memory/{user_id}

// 응답
{
  "success": true,
  "memories": [
    {
      "category": "선호도",
      "key": "답변 형식",
      "value": "표 형식 선호",
      "importance": "high"
    }
  ]
}
```

### 메모리 수동 추가
```javascript
POST /api/memory/{user_id}/manual

{
  "category": "역할",
  "key": "부서",
  "value": "생산팀 라인 1",
  "importance": "high"
}
```

### 대화에서 자동 추출
```javascript
POST /api/memory/{user_id}/save

{
  "conversation_id": "conv-xyz"
}

// 응답
{
  "success": true,
  "saved_count": 3,
  "message": "3개의 중요 정보를 저장했습니다."
}
```

## 📝 프롬프트에 메모리 통합

### LLM이 받는 프롬프트

```
=== 사용자에 대해 알고 있는 정보 ===

[사용자 역할/부서]
- 부서: 생산팀 라인 1 담당

[사용자 선호도]
- 답변 형식: 표 형식 선호

[자주 조회하는 정보]
- 부품: ABC-12345 자주 조회

=== 이전 대화 내용 ===

사용자: 부품 ABC-12345의 재고는?
챗봇: 1,000개입니다.

질문: 그 부품 출고 이력 알려줘

참고 자료:
[검색된 문서...]

위의 사용자 정보와 이전 대화 내용, 그리고 참고 자료를 바탕으로 질문에 답변하세요.
```

## ⚙️ 설정

### 자동 저장 주기 조정
```python
# backend/app/agents/chatbot_agent.py

# 기본값: 10개 메시지마다 저장
if len(messages) >= 10:
    memory_manager.save_conversation_memories()

# 변경 예시: 5개 메시지마다 저장
if len(messages) >= 5:
    memory_manager.save_conversation_memories()
```

### 최대 메시지 수 조정
```python
# backend/app/services/memory_service.py

# 기본값: 10개 메시지 (user + assistant = 20개)
ConversationMemory(conversation_id, max_messages=10)

# 변경 예시: 20개 메시지
ConversationMemory(conversation_id, max_messages=20)
```

## 🧪 테스트 시나리오

### 시나리오 1: 맥락 유지 테스트
```
1. "부품 ABC-12345의 재고는?" 질문
2. "그 부품의 출고 이력은?" 질문
3. "그거 장착 장비는?" 질문

✅ "그 부품", "그거"가 ABC-12345임을 계속 기억
```

### 시나리오 2: 장기 메모리 테스트
```
1. "나는 품질팀이야" 말하기
2. 설정 → 메모리 관리에서 확인
3. "새 대화" 버튼으로 새 대화 시작
4. "부품 정보 알려줘" 질문

✅ 새 대화에서도 품질팀임을 기억하고 품질 관련 정보 우선 제공
```

### 시나리오 3: 선호도 학습 테스트
```
1. "표 형식으로 답변해줘" 요청
2. 다음 질문에서 자동으로 표 형식 답변
3. 설정 → 메모리 관리에서 저장 확인

✅ 선호도가 메모리에 저장되고 다음부터 자동 적용
```

## 💾 데이터베이스 스키마

```javascript
// user_memories collection
{
  _id: ObjectId,
  user_id: "user123",
  category: "선호도",
  key: "답변 형식",
  value: "표 형식 선호",
  importance: "high",
  created_at: ISODate,
  updated_at: ISODate
}
```

## 🎯 장점

1. **맥락 이해**: 이전 대화를 참조하여 자연스러운 대화
2. **개인화**: 사용자별로 맞춤 답변
3. **효율성**: 반복 질문 감소
4. **학습**: 사용할수록 더 똑똑해짐
5. **투명성**: UI에서 저장된 정보 확인 가능

## 🔐 프라이버시

- 사용자별로 완전히 분리된 메모리
- 언제든지 삭제 가능
- 중요 정보는 명시적 동의 후 저장

---

**메모리 시스템으로 더 똑똑한 챗봇!** 🧠✨
